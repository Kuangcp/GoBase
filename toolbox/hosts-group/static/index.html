<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hosts Group</title>

    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate">
    <meta http-equiv="expires" content="0">

    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
</head>
<body>

<style>
    body{
        font-size: 16px;
    }
    .box {
        height: 90vh;
        width: 500px;
        float: left;
        margin-right: 20px;
        margin-top: 5px;
        font-size: 15px;
    }
</style>
<div id="groupSet">
    <button onclick="queryCurrent()"> Current Hosts</button>
    <label for="inputNew">New: </label>
    <input type="text" maxlength="30" minlength="1" id="inputNew">

    <label for="groupSelect">File: </label>
    <select id="groupSelect" onchange="selectChange()">
        <option></option>
    </select>
    <label for="state">Use: </label>
    <input type="checkbox" id="state">
    <button id="submit" onclick="submitPost()">Submit</button>
</div>

<textarea id="content" class="box"></textarea>

<pre id="mergeResult" class="box"></pre>

<script>
    let basePath = '/api/v1.0/'

    function get(url, handle) {
        let httpRequest = new XMLHttpRequest();//第一步：建立所需的对象
        httpRequest.open('GET', url, true);//第二步：打开连接  将请求参数写在url中  ps:"./Ptest.php?name=test&nameone=testone"
        httpRequest.send();//第三步：发送请求  将请求参数写在URL中
        /**
         * 获取数据后的处理程序
         */
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState === 4 && httpRequest.status === 200) {
                handle(httpRequest)

            }
        };
    }

    function queryCurrent() {
        get(basePath + 'currentHosts', function (req) {
            let respTxt = req.responseText;//获取到json字符串，还需解析
            let data = JSON.parse(respTxt);
            if (data.code === 0) {
                console.log(data.data)
                let result = document.getElementById("mergeResult");
                // result.style.backgroundColor = 'lightgray'
                result.innerText = data.data
            } else {
                alert("current hosts not exist")
            }
        })
    }

    function selectChange() {
        let selectObj = document.getElementById("groupSelect");
        let index = selectObj.selectedIndex; //序号，取当前选中选项的序号
        let fileName = selectObj.options[index].value;
        // console.log(fileName)

        get(basePath + 'getFile?file=' + fileName, function (req) {
            let respTxt = req.responseText;//获取到json字符串，还需解析
            let data = JSON.parse(respTxt);
            if (data.code === 0) {
                // console.log(data.data.content)
                document.getElementById("content").innerHTML = data.data.content
                document.getElementById("state").checked = data.data.use
            } else {
                console.log(fileName, "not exist")
            }
        })
    }

    function submitPost() {
        let contentObj = document.getElementById("content");
        // console.log(contentObj.value)

        let finalFileName = document.getElementById("inputNew").value;
        let hasNew = true;
        if (finalFileName.length <= 0) {
            hasNew = false;
            let selectObj = document.getElementById("groupSelect");
            let index = selectObj.selectedIndex; //序号，取当前选中选项的序号
            finalFileName = selectObj.options[index].value;
            // console.log(finalFileName)
        }

        let isUse = document.getElementById("state").checked;

        let fileItem = {
            name: finalFileName,
            content: contentObj.value,
            use: isUse
        };
        // console.log('post', fileItem)

        let httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", basePath + 'postFile', true);
        httpRequest.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
        httpRequest.send(JSON.stringify(fileItem))
        // httpRequest.send("keyword="+keyword+"&name="+name);
        httpRequest.onreadystatechange = () => {
            if (httpRequest.readyState === 4 && httpRequest.status === 200) {
                let data = JSON.parse(httpRequest.responseText);
                if (data.code !==0){
                    alert(data.msg)
                    return
                }
                // console.log(data);
                document.getElementById("state").checked = false
                // clear textarea
                location.replace('/static/?page=' + guid())
            }
        }
    }

    function listFiles() {
        get(basePath + 'listFile', function (req) {
            let respTxt = req.responseText;//获取到json字符串，还需解析
            let data = JSON.parse(respTxt);
            for (let ele in data.data) {
                let datum = data.data[ele];
                // console.log('list: ', datum)
                let selectObj = document.getElementById("groupSelect");

                let opt = new Option(datum.name + (datum.use ? '✔️' : ''), datum.name);
                opt.style.color = datum.use ? 'green' : 'gray';

                selectObj.options.add(opt);
            }
        })
    }

    function guid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            let r = Math.random() * 16 | 0;
            let v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    listFiles()
</script>
</body>
</html>