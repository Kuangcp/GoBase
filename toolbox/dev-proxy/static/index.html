<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Dev Proxy</title>

    <!--  Download Resource https://highlightjs.org/download/ -->
    <link rel="stylesheet" href="monokai-sublime.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="main.js"></script>
    <script src="highlight.min.js"></script>
</head>
<body>

<form style="text-align:center;">
    <!--顺序索引或者分页大小-->
    <input name="idx" style="width:60px;" type="number" id="idx" placeholder="idx" min="1"/>
    <input name="size" style="width:60px;" type="number" id="size" placeholder="size" min="1" value="15"/>

    <input name="id" style="width:120px;" id="id" placeholder="id"/>
    <button type="button" class="req-btn req-btn-replay" onclick="replay()">Replay</button>
    <input type="date" id="date">
    <input name="kwd" id="kwd" style="width:280px;" placeholder="key word"/>
    <button type="button" class="req-btn req-btn-curl" onclick="search()">Search</button>
    <button type="button" onclick="refresh()">Reload</button>

    Page: <span id="pageDiv" onclick="setLastPage()" style="width: 40px"></span>
    Total: <span id="totalDiv" style="width: 40px"></span>

</form>
<table id="req-log">
    <thead id="req-log-head"></thead>
    <tbody id="req-log-body" style="border: solid" class="req-log-body"></tbody>
</table>
<div id="detail">
    <div id="detail-request-head"></div>
    <div id="detail-request"></div>
    <div id="detail-response-head"></div>
    <div id="detail-response"></div>
</div>
<script>

    let reqDict = {}
    // 初始化
    init()

    function init() {
        search()
        let item = document.getElementById("kwd");
        item.addEventListener("keyup", function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                search()
            }
        });

        document.getElementById("detail-request").innerHTML = ""
        document.getElementById("detail-response").innerHTML = ""
    }

    function val(idStr) {
        return document.getElementById(idStr).value
    }

    function refresh() {
        window.location.reload();
    }

    // input A,B
    // output A=1&B=2
    function appendParam(...varList) {
        let list = []
        for (let v of varList) {
            list.push(v + "=" + val(v))
        }
        return list.join("&")
    }

    function showDetail(id) {
        let req = reqDict[id];

        document.getElementById("detail-request-head").innerHTML = "<div class='req-req-head'> <pre class='hljs'><code>" + JSON.stringify(req.request.header, null, 2) + "</code></pre></div>"
        document.getElementById("detail-response-head").innerHTML = "<div class='req-req-head'> <pre class='hljs'><code>" + JSON.stringify(req.response.header, null, 2) + "</code></pre></div>"
        document.getElementById("detail-request").innerHTML = "<div class='req-req-body'> <pre class='hljs'><code>" + JSON.stringify(req.request.body, null, 2) + "</code></pre></div>"
        document.getElementById("detail-response").innerHTML = "<div class='req-rsp-body'> <pre class='hljs'><code>" + JSON.stringify(req.response.body, null, 2) + "</code></pre></div>"
        hljs.highlightAll()
    }

    function buildLine(i, l) {
        reqDict[l.id] = l

        return "<tr onclick='showDetail(\"" + l.id + "\")'>" +
            "<td class='req-use-time' onclick='copyVal(\"" + l.id + "\")'> <span style='color:rebeccapurple'> [ " + (parseInt(i) + 1) + " ] </span> " + l.id + "</td>" +
            "<td> " + l.statusCode + "</td>" +
            "<td> <div class='req-url'> " + l.url + " </div></td>" +
            "<td style='width: 110px;font-size: small'>" + new Date(Date.parse(l.reqTime)).format('MM-dd hh:mm:ss') + "</td>" +
            "<td class='req-use-time'>" + l.useTime + "</td>" +
            '<td> ' +
            '<button type="button" class="req-btn req-btn-replay" onclick="replayById(\'' + l.id + '\')">Replay</button>' +
            '<button type="button" class="req-btn req-btn-curl" onclick="copyCurlCommand(\'' + l.id + '\')">cUrl</button>' +
            '<button type="button" class="req-btn req-btn-delete" onclick="deleteReq(\'' + l.id + '\')">Del</button>' +
            '</td>' +
            "</tr>";
    }

    function search() {
        reqDict = {};
        get("/list?" + appendParam("id", "idx", "date", "kwd", "size"), function (data) {
            let result = JSON.parse(data);
            let table = document.getElementById("req-log-body");
            let head = document.getElementById("req-log-head");
            head.innerHTML = ""
            table.innerHTML = ""
            if (!result.data) {
                return
            }

            document.getElementById("pageDiv").innerHTML = result.data.page
            document.getElementById("totalDiv").innerHTML = result.data.total
            if (!result.data.data || result.data.data.length <= 0) {
                return
            }

            head.innerHTML = "<th>Id</th>" +
                "            <th title='98 不可达 99 服务异常'>Code</th>" +
                "            <th>URL</th>" +
                "            <th>请求时间</th>" +
                "            <th>耗时</th>" +
                // "            <th>请求</th>" +
                // "            <th>响应</th>" +
                "            <th>操作</th>"

            for (let i in result.data.data) {
                let l = result.data.data[i]
                table.innerHTML += buildLine(i, l)
            }
        })
    }

    async function setLastPage() {
        document.getElementById("idx").value = document.getElementById("pageDiv").innerText
        search()
    }

    async function copyVal(txt) {
        await navigator.clipboard.writeText(txt)
    }

    function copyCurlCommand(id) {
        get("/curl?selfProxy=Y&id=" + id, async function (data) {
            await navigator.clipboard.writeText(data);
        })
    }

    function deleteReq(id) {
        get("/del?id=" + id, function (data) {
            console.log(data)
            search()
        })
    }

    function replayById(id) {
        get("/replay?selfProxy=Y&id=" + id, function (data) {
            search()
            let maxLen = 400
            if (data && data.length > maxLen) {
                // console.log(data.substring(0,maxLen))
                alert(data.substring(0, maxLen) + "  ...")
            } else {
                alert(data);
            }
        })
    }


    function replay() {
        let id = val("id");
        if (!id || id === "") {
            alert("请输入重试请求的 id")
            return
        }
        replayById(id)
    }

</script>
</body>
</html>